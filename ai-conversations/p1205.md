# 민순의 요청

```text
* 역할: 너는 Apps Script 장애 대응 전문가야.
* 상황: 스크립트 실행 중에 에러가 났거나 무한 루프가 발생해서 당황하고 있어.
* 과업:
  1. 로그를 보고 원인을 분석해 줘. (예: 429 에러면 할당량 초과라고 알려 줘)
  2. 재발 방지를 위해 '한 번에 최대 10개까지만 처리'하거나 '에러 발생 시 관리자에게 이메일 발송'하는 안전 장치 코드를 추가해 줘.
* 출력: 원인 분석 및 수정된 코드
* 입력: [에러 로그 붙여넣기]
 (예시: Exception: Service invoked too many times for one day: MailApp. (line 15, file "Code"))
```

# 제미나이의 응답

제시해주신 예시 에러 로그(**Exception: Service invoked too many times for one day: MailApp**)를 바탕으로 분석 및 해결책을 제시해 드리겠습니다. 당황하지 마세요, 이 에러는 매우 흔하게 발생하는 할당량 문제입니다.

---

### 1. 🔍 원인 분석

*   **에러 메시지:** `Exception: Service invoked too many times for one day: MailApp.`
*   **진단:** **"일일 이메일 전송 할당량 초과"**입니다.
*   **상세 설명:**
    *   Google Apps Script는 계정 유형에 따라 하루에 사용할 수 있는 서비스(이메일, 트리거, URL Fetch 등)의 횟수에 제한이 있습니다.
    *   **무료 Gmail 계정:** 하루 약 100통
    *   **Google Workspace (유료) 계정:** 하루 약 1,500통 (도메인 정책에 따라 다름)
    *   이 에러는 스크립트가 무한 루프에 빠져 이메일을 계속 보냈거나, 처리해야 할 데이터 양이 하루 제한을 넘었을 때 발생합니다.

---

### 2. 🛡️ 솔루션: 안전 장치가 포함된 수정 코드

재발 방지를 위해 다음 두 가지 기능을 추가했습니다.
1.  **배치 처리 (Batch Processing):** 한 번 실행 시 **최대 10개**까지만 처리하고 강제로 종료합니다. (트리거를 이용해 나눠서 보내는 방식의 기초가 됩니다.)
2.  **에러 핸들링 (Try-Catch):** 에러 발생 시 스크립트가 멈추지 않고, 관리자에게 알림을 보내거나 로그를 남깁니다.

```javascript
function sendEmailsSafely() {
  // 설정값
  const MAX_EMAILS_PER_RUN = 10; // 한 번에 처리할 최대 개수 (안전 장치)
  const ADMIN_EMAIL = "admin@example.com"; // 에러 발생 시 알림 받을 이메일
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const dataRange = sheet.getDataRange();
  const data = dataRange.getValues();
  
  let emailCount = 0; // 이번 실행에서 보낸 이메일 수 카운트

  // 헤더를 제외하고 2번째 줄부터 반복 (i=1)
  for (let i = 1; i < data.length; i++) {
    
    // [안전 장치 1] 최대 처리 개수에 도달하면 루프 종료
    if (emailCount >= MAX_EMAILS_PER_RUN) {
      Logger.log("⚠️ 안전을 위해 " + MAX_EMAILS_PER_RUN + "개 처리 후 종료합니다.");
      break; 
    }

    const row = data[i];
    const emailAddress = row[0]; // 예: A열에 이메일 주소
    const status = row[2];       // 예: C열에 처리 상태 (Sent 등)

    // 이미 처리된 건은 건너뜀 (중복 방지)
    if (status === "Sent") {
      continue;
    }

    try {
      // --- 이메일 전송 로직 시작 ---
      MailApp.sendEmail({
        to: emailAddress,
        subject: "안녕하세요, 안내 메일입니다.",
        body: "본문 내용입니다."
      });
      // --- 이메일 전송 로직 끝 ---

      // 성공 시 상태 업데이트 (중복 발송 방지)
      sheet.getRange(i + 1, 3).setValue("Sent"); // C열(3번째 열)에 기록
      
      emailCount++; // 카운트 증가
      Logger.log((i + 1) + "행 처리 완료");

    } catch (e) {
      // [안전 장치 2] 에러 발생 시 처리
      Logger.log("❌ " + (i + 1) + "행 에러 발생: " + e.toString());
      
      // 에러 내용을 시트에 기록 (D열 등 비고란에)
      sheet.getRange(i + 1, 4).setValue("Error: " + e.toString());

      // 관리자에게 긴급 알림 발송
      // (주의: 이미 이메일 할당량이 초과된 상태라면 이 알림도 실패할 수 있으므로 try-catch로 한 번 더 감쌉니다)
      try {
        MailApp.sendEmail(ADMIN_EMAIL, "🚨 스크립트 에러 알림", "에러 내용: " + e.toString());
      } catch (mailError) {
        Logger.log("관리자 알림 메일 발송 실패 (할당량 초과 가능성): " + mailError.toString());
      }
    }
  }
}
```

### 💡 코드 적용 가이드

1.  **`MAX_EMAILS_PER_RUN = 10`**: 이 숫자를 조절하여 한 번에 처리할 양을 통제하세요. 테스트 중에는 작게 유지하는 것이 좋습니다.
2.  **상태 체크 (`if (status === "Sent")`)**: 무한 루프가 돌더라도 이미 보낸 사람에게 또 보내지 않도록, 반드시 시트에 '발송 완료' 표시를 하고 이를 체크하는 로직을 유지하세요.
3.  **트리거 설정**: 데이터가 100개라면, 이 스크립트를 '시간 기반 트리거(예: 1시간마다)'로 설정해두면 10개씩 나누어 안전하게 처리됩니다.

**지금 겪고 계신 실제 에러 로그나 코드가 다르다면, 바로 아래에 붙여넣어 주세요. 해당 상황에 맞춰 다시 분석해 드리겠습니다!**