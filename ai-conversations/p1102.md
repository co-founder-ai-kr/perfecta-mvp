# 민순의 요청

```text
* 역할: 너는 구글 앱스 스크립트 전문 개발자야.
* 상황: '스크립트 속성'에 저장된 API 키를 사용하여 챗 봇의 두뇌를 연결하고 싶어. 코딩 지식이 없는 창업가가 복사해서 바로 쓸 수 있어야 해.
* 과업:
  1. `GOOGLE_API_KEY` 속성을 불러오는 코드를 작성해 줘.
  2. 사용자의 질문(`userQuery`)과 구글 시트에서 가져온 데이터(`context`)를 합쳐서 제미나이 API에 전송하고, 답변을 받아오는 `callGeminiAPI` 함수를 작성해 줘.
  3. 웹 앱으로 배포할 거니까 `doPost` 함수를 사용해서 작성해 줘.
* 제약:
  - 초보자가 복사해서 바로 쓸 수 있게 전체 코드를 제공해 줘.
  - 코드의 각 부분이 어떤 역할을 하는지 '주방장'과 '재료'에 비유해서 한글 주석을 달아 줘.
* 출력: 앱스 스크립트 코드 블록
* 입력: [구글 시트 데이터 구조]
 (예시: 시트 이름은 'Data', A열은 질문, B열은 답변 내용이 들어 있어.)
```

# 제미나이의 응답

안녕하세요! 구글 앱스 스크립트(GAS) 전문 셰프입니다. 👨‍🍳

코딩을 전혀 모르셔도 괜찮습니다. 창업가님께서 바로 복사해서 사용하실 수 있도록, **'주방장(함수)'**과 **'재료(변수)'**에 비유하여 친절하게 주석을 달아두었습니다.

이 코드는 **구글 시트의 데이터를 참고하여, 제미나이(Gemini)가 고객의 질문에 똑똑하게 답변**하도록 만들어줍니다.

### 📋 사용 전 준비 사항
1.  **스크립트 속성 설정**:
    *   앱스 스크립트 왼쪽 메뉴의 **톱니바퀴(프로젝트 설정)** 클릭
    *   스크롤을 내려 **'스크립트 속성'** 섹션에서 `스크립트 속성 추가` 클릭
    *   속성: `GOOGLE_API_KEY` / 값: `발급받은_Gemini_API_키` 입력 후 저장
2.  **구글 시트 준비**:
    *   시트 이름을 반드시 **'Data'**로 변경해주세요.
    *   A열에는 예상 질문, B열에는 답변 내용을 적어주세요.

---

### 💻 복사해서 붙여넣을 코드

```javascript
// ==========================================
// 🤖 AI 챗봇 주방장 스크립트 (Gemini 연동)
// ==========================================

/**
 * 1. 메인 주방장 (doPost)
 * 역할: 외부(웹/앱)에서 주문(질문)이 들어오면 요리를 시작하고, 완성된 요리(답변)를 서빙합니다.
 */
function doPost(e) {
  try {
    // [재료 준비] 주문서(JSON 데이터)를 읽기 좋게 펼칩니다.
    // 외부에서 {"message": "안녕하세요"} 형태로 보냈다고 가정합니다.
    var params = JSON.parse(e.postData.contents);
    var userQuery = params.message; // 사용자의 질문

    // [재료 손질] 냉장고(구글 시트)에서 참고할 신선한 재료(데이터)를 꺼내옵니다.
    var context = getContextFromSheet();

    // [요리 시작] 제미나이 셰프에게 재료와 질문을 주고 요리(답변 생성)를 시킵니다.
    var aiResponse = callGeminiAPI(userQuery, context);

    // [서빙] 완성된 요리(답변)를 손님에게 내보냅니다.
    return ContentService.createTextOutput(JSON.stringify({
      "status": "success",
      "reply": aiResponse
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // [비상 상황] 요리 중 실수가 발생하면 사과 메시지를 보냅니다.
    return ContentService.createTextOutput(JSON.stringify({
      "status": "error",
      "reply": "죄송합니다. 잠시 문제가 발생했습니다. (" + error.toString() + ")"
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * 2. 제미나이 셰프 (callGeminiAPI)
 * 역할: 비밀 소스(API 키)를 사용해 제미나이 두뇌에 질문을 던지고 답변을 받아옵니다.
 */
function callGeminiAPI(userQuery, context) {
  // [비밀 소스] 금고(스크립트 속성)에서 API 키를 꺼냅니다.
  var apiKey = PropertiesService.getScriptProperties().getProperty('GOOGLE_API_KEY');
  
  // [요리 도구] 제미나이 1.5 Flash 모델을 사용합니다. (빠르고 효율적임)
  var apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey;

  // [레시피] 제미나이에게 줄 지시사항을 만듭니다.
  var prompt = "너는 친절하고 전문적인 상담원이야.\n" +
               "아래의 [참고 데이터]를 바탕으로 [사용자 질문]에 답변해줘.\n" +
               "데이터에 없는 내용은 지어내지 말고, 상담원 연결이 필요하다고 말해줘.\n\n" +
               "[참고 데이터]:\n" + context + "\n\n" +
               "[사용자 질문]: " + userQuery;

  // [포장] API에 보낼 데이터를 규격에 맞게 포장합니다.
  var payload = {
    "contents": [{
      "parts": [{
        "text": prompt
      }]
    }]
  };

  var options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true // 에러가 나도 멈추지 않고 내용을 확인합니다.
  };

  // [배달] 제미나이 서버로 요청을 보내고 응답을 받습니다.
  var response = UrlFetchApp.fetch(apiUrl, options);
  var json = JSON.parse(response.getContentText());

  // [검수] 응답이 정상적으로 왔는지 확인하고 텍스트만 추출합니다.
  if (json.candidates && json.candidates.length > 0) {
    return json.candidates[0].content.parts[0].text;
  } else {
    return "AI가 답변을 생성하지 못했습니다. 다시 시도해주세요.";
  }
}

/**
 * 3. 재료 손질 보조 (getContextFromSheet)
 * 역할: 구글 시트 'Data' 탭에서 데이터를 긁어와서 하나의 텍스트 덩어리로 만듭니다.
 */
function getContextFromSheet() {
  // [냉장고 열기] 현재 스프레드시트의 'Data' 시트를 찾습니다.
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Data');
  
  // 시트가 없으면 빈 재료를 반환합니다.
  if (!sheet) return "참고할 데이터 시트(Data)가 없습니다.";

  // [재료 꺼내기] 데이터가 있는 범위를 모두 가져옵니다.
  var data = sheet.getDataRange().getValues();
  
  var contextString = "";
  
  // 첫 번째 줄(헤더)은 건너뛰고 두 번째 줄부터 읽습니다. (i=1)
  for (var i = 1; i < data.length; i++) {
    var question = data[i][0]; // A열: 질문
    var answer = data[i][1];   // B열: 답변
    
    // 질문과 답변이 있는 경우에만 재료로 추가합니다.
    if (question && answer) {
      contextString += "- 질문: " + question + " / 답변: " + answer + "\n";
    }
  }
  
  return contextString;
}
```

### 🚀 배포 방법 (마무리)

1.  코드를 붙여넣은 후 `Ctrl + S`를 눌러 저장합니다.
2.  우측 상단 **[배포]** 버튼 -> **[새 배포]**를 클릭합니다.
3.  유형 선택 톱니바퀴 -> **[웹 앱]**을 선택합니다.
4.  설정:
    *   설명: `AI 챗봇 v1` (자유롭게 입력)
    *   다음 사용자 계정으로 실행: **`나(자신의 이메일)`**
    *   액세스 권한이 있는 사용자: **`모든 사용자`** (이게 중요합니다! 그래야 외부 챗봇 툴이 접속 가능합니다.)
5.  **[배포]** 클릭 후 나오는 **웹 앱 URL**을 복사해서 챗봇 빌더(예: 카카오톡 챗봇, 버블 등)의 API 주소란에 넣으시면 됩니다.