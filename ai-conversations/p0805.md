# 민순의 요청

```text
* 역할: 너는 앱스 스크립트 보안 전문가야.
* 상황: HTML 파일에 API Key를 노출하는 실수를 저질러서 보안이 걱정되는 상황이야.
* 과업: 
  1. 앱스 스크립트 ‘스크립트 속성’에 키를 숨기는 방법을 알려 줘.
  2. 앱스 스크립트가 대신 호출해서 결과만 전달하는 안전한 코드를 작성해 줘.
* 제약: 
  - 접속 방법부터 단계별로 설명해 줘.
  - 주석은 비즈니스 로직을 설명하는 내용으로 달아 줘.
* 출력: 
  1. 스크립트 속성 설정 가이드
  2. 안전한 호출 코드
* 입력: [사용하려는 API 이름]
 (예시: OpenWeatherMap API)
```

# 제미나이의 응답

반갑습니다. 앱스 스크립트 보안 전문가입니다.

HTML 파일(클라이언트 사이드)에 API Key를 하드코딩하는 것은 누구나 브라우저의 '소스 보기'를 통해 키를 훔쳐갈 수 있어 매우 위험합니다. 하지만 걱정하지 마세요. 앱스 스크립트의 **'스크립트 속성(Script Properties)'**과 **'서버 사이드 프록시 패턴'**을 이용하면 이 문제를 완벽하게 해결할 수 있습니다.

입력해주신 **[OpenWeatherMap API]**를 예시로, 안전하게 키를 숨기고 호출하는 방법을 단계별로 안내해 드리겠습니다.

---

### 1. 스크립트 속성 설정 가이드 (API Key 숨기기)

이 과정은 API Key를 코드에서 분리하여 구글 서버 내부의 안전한 저장소에 보관하는 단계입니다.

1.  **프로젝트 설정 열기**:
    *   앱스 스크립트 에디터 화면 왼쪽 사이드바에서 톱니바퀴 아이콘 **[프로젝트 설정]**을 클릭합니다.
2.  **스크립트 속성 섹션 이동**:
    *   설정 페이지의 스크롤을 맨 아래로 내리면 **'스크립트 속성'** 섹션이 보입니다.
3.  **속성 추가**:
    *   **[스크립트 속성 추가]** 버튼을 클릭합니다.
4.  **키/값 입력**:
    *   **속성(Property)**: 코드에서 불러올 변수명입니다. (예: `WEATHER_API_KEY`)
    *   **값(Value)**: 실제 OpenWeatherMap API Key를 여기에 붙여넣습니다. (예: `abc12345...`)
5.  **저장**:
    *   **[스크립트 속성 저장]** 버튼을 눌러 완료합니다.

이제 코드는 `WEATHER_API_KEY`라는 이름만 알 뿐, 실제 키 값은 알지 못하므로 안전합니다.

---

### 2. 안전한 호출 코드 (Server-side Proxy)

이제 클라이언트(HTML)가 직접 API를 부르는 것이 아니라, **앱스 스크립트(서버)**에게 "날씨 정보 좀 가져다줘"라고 요청하고, 앱스 스크립트가 숨겨둔 키를 사용해 API를 호출한 뒤 결과만 돌려주는 방식을 사용합니다.

#### A. 서버 측 코드 (`Code.gs`)

이 코드는 구글 서버에서 실행되므로 사용자는 API Key를 절대 볼 수 없습니다.

```javascript
/**
 * 클라이언트의 요청을 받아 OpenWeatherMap API를 대신 호출하고 결과를 반환하는 함수
 * @param {string} cityName - 날씨를 조회할 도시 이름 (예: 'Seoul')
 * @return {string} - API에서 받은 JSON 데이터 문자열
 */
function getSecureWeatherData(cityName) {
  // 1. 보안 저장소(스크립트 속성)에서 API Key를 안전하게 조회합니다.
  // 코드가 유출되어도 이 부분은 실제 키 값이 아니므로 안전합니다.
  var scriptProperties = PropertiesService.getScriptProperties();
  var apiKey = scriptProperties.getProperty('WEATHER_API_KEY');

  // 2. API Key가 설정되지 않았을 경우를 대비한 예외 처리 로직입니다.
  if (!apiKey) {
    throw new Error('API Key가 스크립트 속성에 설정되지 않았습니다.');
  }

  // 3. 외부 API 요청을 위한 URL을 구성합니다. (비즈니스 로직: 도시명과 키 결합)
  var baseUrl = 'https://api.openweathermap.org/data/2.5/weather';
  var requestUrl = baseUrl + '?q=' + encodeURIComponent(cityName) + '&appid=' + apiKey + '&units=metric';

  try {
    // 4. 구글 서버가 대신 외부 API를 호출(Fetch)합니다.
    var response = UrlFetchApp.fetch(requestUrl);
    
    // 5. 성공적으로 데이터를 받으면 내용을 텍스트 형태로 반환합니다.
    return response.getContentText();

  } catch (e) {
    // API 호출 실패 시 에러 로그를 남기고 클라이언트에 에러 메시지를 전달합니다.
    Logger.log('API 호출 에러: ' + e.toString());
    throw new Error('날씨 정보를 가져오는 데 실패했습니다.');
  }
}

/**
 * HTML 파일을 웹 앱으로 띄우기 위한 기본 함수
 */
function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index');
}
```

#### B. 클라이언트 측 코드 (`Index.html`)

HTML 파일에는 API Key가 전혀 포함되지 않습니다. 단지 `google.script.run`을 통해 서버 함수를 호출할 뿐입니다.

```html
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 20px; }
      .result-box { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
    </style>
  </head>
  <body>
    <h2>안전한 날씨 조회 (API Key 미노출)</h2>
    <input type="text" id="cityInput" value="Seoul" placeholder="도시 이름 입력">
    <button onclick="callWeatherApi()">날씨 조회</button>
    
    <div id="result" class="result-box">결과가 여기에 표시됩니다.</div>

    <script>
      /**
       * 사용자가 버튼을 클릭했을 때 실행되는 함수
       * 직접 API를 호출하지 않고, 구글 서버(Code.gs)에 요청을 위임합니다.
       */
      function callWeatherApi() {
        var city = document.getElementById('cityInput').value;
        var resultDiv = document.getElementById('result');
        
        resultDiv.innerHTML = '로딩 중...';

        // 1. google.script.run을 사용하여 서버 측 함수(getSecureWeatherData)를 비동기로 호출합니다.
        google.script.run
          .withSuccessHandler(function(data) {
            // 2. 서버로부터 성공적으로 데이터를 받았을 때 실행되는 로직입니다.
            // 받은 JSON 문자열을 파싱하여 화면에 표시합니다.
            var weatherData = JSON.parse(data);
            var temp = weatherData.main.temp;
            var desc = weatherData.weather[0].description;
            
            resultDiv.innerHTML = '<strong>' + city + '</strong>의 현재 기온: ' + temp + '°C (' + desc + ')';
          })
          .withFailureHandler(function(error) {
            // 3. 서버 측에서 에러가 발생했을 때 실행되는 로직입니다.
            resultDiv.innerHTML = '에러 발생: ' + error.message;
          })
          .getSecureWeatherData(city); // 서버 함수 이름 및 매개변수 전달
      }
    </script>
  </body>
</html>
```

### 요약
이제 누군가 당신의 HTML 소스 코드를 보더라도 `google.script.run.getSecureWeatherData(city)`만 보일 뿐, 실제 **OpenWeatherMap API Key**는 어디에도 노출되지 않습니다. 이것이 가장 안전한 앱스 스크립트 API 연동 방식입니다.