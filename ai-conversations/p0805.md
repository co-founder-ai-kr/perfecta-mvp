# 민순의 요청

```text
* 역할: 너는 앱스 스크립트 보안 전문가야.
* 상황: 초보 창업가가 HTML 파일에 API Key를 노출하는 실수를 저질러서 보안이 걱정되는 상황이야.
* 과업: 
  1. 앱스 스크립트 ‘스크립트 속성’에 키를 숨기는 방법을 알려 줘.
  2. 앱스 스크립트가 대신 호출해서 결과만 전달하는 안전한 코드를 작성해 줘.
* 제약: 
  - 접속 방법부터 단계별로 설명해 줘.
  - 주석은 비즈니스 로직을 설명하는 내용으로 달아 줘.
* 출력: 
  1. 스크립트 속성 설정 가이드
  2. 안전한 호출 코드
* 입력: [사용하려는 API 이름]
 (예시: OpenWeatherMap API)
```

# 제미나이의 응답

반갑습니다. 앱스 스크립트 보안 전문가입니다.

초기 창업 단계에서 기능 구현에 집중하다 보면 흔히 할 수 있는 실수입니다. HTML이나 클라이언트 사이드 자바스크립트에 API Key를 그대로 적으면, 브라우저의 '소스 보기'만으로도 누구나 키를 훔쳐갈 수 있어 매우 위험합니다.

하지만 **Google Apps Script(GAS)**는 서버리스 환경을 제공하므로, **'스크립트 속성(Script Properties)'**과 **'서버 사이드 함수'**를 이용해 이 문제를 완벽하게 해결할 수 있습니다.

입력해주신 예시인 **[OpenWeatherMap API]**를 기준으로, 보안을 강화하는 단계를 안내해 드리겠습니다.

---

### 1. 스크립트 속성 설정 가이드 (API Key 숨기기)

이 과정은 API Key를 코드에서 지우고, 구글 서버 내부의 안전한 금고(속성 저장소)로 옮기는 작업입니다.

1.  **프로젝트 설정 열기**:
    *   앱스 스크립트 에디터 화면 왼쪽 사이드바에서 톱니바퀴 아이콘 **[프로젝트 설정]**을 클릭합니다.
2.  **스크립트 속성 찾기**:
    *   화면을 아래로 스크롤 하여 **'스크립트 속성'** 섹션을 찾습니다.
3.  **속성 추가**:
    *   **[스크립트 속성 수정]** 버튼을 클릭합니다.
    *   **[속성 추가]**를 클릭합니다.
4.  **키-값 입력**:
    *   **속성(Property)**: `WEATHER_API_KEY` (코드에서 이 이름으로 키를 부릅니다)
    *   **값(Value)**: `여기에_실제_API_KEY를_붙여넣으세요`
5.  **저장**:
    *   **[스크립트 속성 저장]** 버튼을 누릅니다.

이제 코드를 공유하더라도 API Key는 노출되지 않습니다.

---

### 2. 안전한 호출 코드 작성

이제 HTML이 직접 API를 부르는 것이 아니라, **HTML은 앱스 스크립트(서버)에 요청하고, 앱스 스크립트가 API를 호출한 뒤 결과만 HTML에 돌려주는 방식**으로 변경합니다.

#### A. 서버 측 코드 (`Code.gs`)
이 코드는 구글 서버에서 실행되므로 사용자는 내용을 볼 수 없습니다.

```javascript
/**
 * 클라이언트(HTML)로부터 도시 이름을 받아 날씨 정보를 조회하는 함수
 * @param {string} city - 조회할 도시 이름 (예: Seoul)
 * @return {object} - 날씨 데이터 또는 에러 메시지
 */
function getSecureWeatherData(city) {
  try {
    // 1. 보안 저장소(스크립트 속성)에서 숨겨둔 API Key를 꺼내옵니다.
    const scriptProperties = PropertiesService.getScriptProperties();
    const apiKey = scriptProperties.getProperty('WEATHER_API_KEY');

    if (!apiKey) {
      throw new Error('API 키가 설정되지 않았습니다.');
    }

    // 2. 외부 날씨 서비스(OpenWeatherMap)에 요청할 주소를 생성합니다.
    // (비즈니스 로직: 섭씨 온도(metric) 기준으로 요청)
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

    // 3. 구글 서버가 대신 외부 API를 호출하여 데이터를 받아옵니다.
    const response = UrlFetchApp.fetch(url);
    
    // 4. 받아온 결과(JSON 문자열)를 자바스크립트 객체로 변환합니다.
    const data = JSON.parse(response.getContentText());

    // 5. (선택 사항) 클라이언트에게 필요한 핵심 정보만 가공하여 전달할 수도 있습니다.
    // 여기서는 전체 데이터를 넘겨줍니다.
    return {
      success: true,
      data: data
    };

  } catch (error) {
    // 에러 발생 시, 시스템 에러 로그를 남기고 사용자에게는 안전한 에러 메시지만 전달합니다.
    console.error('날씨 조회 중 오류 발생: ' + error.toString());
    return {
      success: false,
      message: '날씨 정보를 가져오는 데 실패했습니다. 도시 이름을 확인해주세요.'
    };
  }
}
```

#### B. 클라이언트 측 코드 (`Index.html`)
HTML 파일에는 API Key가 전혀 포함되지 않습니다. 오직 `google.script.run`을 통해 서버 함수를 호출할 뿐입니다.

```html
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 20px; }
      .result { margin-top: 20px; padding: 10px; background: #f0f0f0; }
    </style>
  </head>
  <body>
    <h2>안전한 날씨 조회기</h2>
    <input type="text" id="cityInput" placeholder="도시 이름 (예: Seoul)" value="Seoul">
    <button onclick="fetchWeather()">날씨 확인</button>
    
    <div id="output" class="result">결과가 여기에 표시됩니다.</div>

    <script>
      function fetchWeather() {
        const city = document.getElementById('cityInput').value;
        const outputDiv = document.getElementById('output');
        
        outputDiv.innerHTML = '로딩 중...';

        // google.script.run을 사용하여 서버 측(Code.gs)의 함수를 호출합니다.
        // 이 과정에서 사용자는 API Key를 절대 알 수 없습니다.
        google.script.run
          .withSuccessHandler(function(response) {
            // 서버로부터 응답을 성공적으로 받았을 때 실행되는 로직
            if (response.success) {
              const weather = response.data;
              const temp = weather.main.temp;
              const desc = weather.weather[0].description;
              
              outputDiv.innerHTML = `
                <strong>${weather.name}</strong>의 날씨:<br>
                온도: ${temp}°C<br>
                상태: ${desc}
              `;
            } else {
              // 서버에서 에러 메시지를 보냈을 때 처리
              outputDiv.innerHTML = `<span style="color:red;">${response.message}</span>`;
            }
          })
          .withFailureHandler(function(error) {
            // 통신 자체에 실패했을 때 처리
            outputDiv.innerHTML = '서버 통신 오류가 발생했습니다.';
          })
          .getSecureWeatherData(city); // Code.gs에 작성한 함수 이름
      }
    </script>
  </body>
</html>
```

### 요약
이제 창업가님의 앱은 다음과 같이 작동합니다.

1.  사용자가 버튼을 누름.
2.  브라우저가 구글 앱스 스크립트 서버에 요청 (`google.script.run`).
3.  **구글 서버**가 비밀 금고에서 키를 꺼내 OpenWeatherMap에 다녀옴.
4.  **구글 서버**가 결과만 브라우저에 전달.

이 방식을 사용하면 HTML 소스를 아무리 뜯어봐도 API Key를 찾을 수 없습니다. 안심하고 서비스를 개발하세요!