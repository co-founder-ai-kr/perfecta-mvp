# 민순의 요청

```text
* 역할: 너는 사이트 신뢰성 엔지니어(SRE)야.
* 상황: 내 웹 사이트가 멈추면 즉시 알고 싶어.
* 과업:
  1. 내 웹 사이트 URL에 5분마다 접속해서 상태를 확인하는 Apps Script를 짜 줘.
  2. 만약 응답 코드가 200(정상)이 아니면 즉시 내 이메일로 "비상! 서버 다운!"이라는 제목의 메일을 보내게 해 줘.
* 제약: 트리거 설정 방법도 주석으로 알려 줘.
* 출력: Apps Script 코드
* 입력: [모니터링할 웹 사이트 URL과 알림을 받을 이메일 주소]
 (예시: 웹 사이트 URL 'https://myperfecta.com', 알림 이메일 'admin@myperfecta.com')
```

# 제미나이의 응답

안녕하세요! SRE(사이트 신뢰성 엔지니어)로서 귀하의 웹 사이트 가용성을 모니터링하고, 장애 발생 시 즉각적인 알림을 받을 수 있는 Google Apps Script 코드를 작성해 드립니다.

이 스크립트는 HTTP 응답 코드를 확인하고, 네트워크 오류(DNS 실패 등)까지 감지하여 메일을 발송하도록 견고하게 작성되었습니다.

### 🛠️ 웹 사이트 모니터링 Apps Script

아래 코드를 복사하여 Google Apps Script 프로젝트에 붙여넣으세요.
**상단의 `SITE_URL`과 `ADMIN_EMAIL` 변수만 수정하시면 됩니다.**

```javascript
/**
 * 웹 사이트 상태 모니터링 스크립트
 * 
 * 설정 방법:
 * 1. SITE_URL에 모니터링할 웹 사이트 주소를 입력하세요.
 * 2. ADMIN_EMAIL에 알림을 받을 이메일 주소를 입력하세요.
 * 3. 이 스크립트에 '시간 기반 트리거'를 설정하여 5분마다 실행되게 하세요.
 */

// ==========================================
// [사용자 입력 설정]
const SITE_URL = 'https://myperfecta.com';    // 모니터링할 웹 사이트 URL
const ADMIN_EMAIL = 'admin@myperfecta.com';   // 알림을 받을 이메일 주소
// ==========================================

function checkWebsiteStatus() {
  console.log(`[모니터링 시작] 대상: ${SITE_URL}`);
  
  try {
    // muteHttpExceptions: true 옵션은 404나 500 에러가 발생해도 스크립트를 중단시키지 않고 응답을 받아옵니다.
    const options = {
      'muteHttpExceptions': true,
      'validateHttpsCertificates': false, // 인증서 오류 무시 (필요 시 true로 변경)
      'followRedirects': true             // 리다이렉트 허용
    };
    
    const response = UrlFetchApp.fetch(SITE_URL, options);
    const responseCode = response.getResponseCode();
    
    // HTTP 상태 코드가 200(성공)이 아닌 경우
    if (responseCode !== 200) {
      sendAlertEmail(`응답 코드 오류: ${responseCode}`, `웹 사이트가 정상적인 200 OK 응답을 반환하지 않았습니다.\n현재 상태 코드: ${responseCode}`);
    } else {
      console.log(`[정상] 상태 코드: 200 OK`);
    }

  } catch (e) {
    // 사이트 접속 자체가 불가능한 경우 (DNS 오류, 타임아웃, 서버 다운 등)
    console.error(`[오류] 접속 실패: ${e.message}`);
    sendAlertEmail(`접속 실패 (Exception)`, `스크립트가 웹 사이트에 접속할 수 없습니다.\n에러 메시지: ${e.message}`);
  }
}

/**
 * 경고 이메일 발송 헬퍼 함수
 */
function sendAlertEmail(reason, details) {
  const subject = "비상! 서버 다운!";
  const body = `
    [웹 사이트 장애 감지]
    
    대상 URL: ${SITE_URL}
    감지 시간: ${new Date().toLocaleString()}
    
    장애 원인: ${reason}
    
    상세 내용:
    ${details}
    
    즉시 확인 바랍니다.
  `;
  
  MailApp.sendEmail({
    to: ADMIN_EMAIL,
    subject: subject,
    body: body
  });
  
  console.log(`[알림 발송] 이메일 전송 완료: ${ADMIN_EMAIL}`);
}

/*
 * ============================================================
 * [트리거 설정 방법]
 * 
 * 1. 왼쪽 메뉴에서 '트리거'(시계 아이콘)를 클릭합니다.
 * 2. 오른쪽 하단의 '+ 트리거 추가' 버튼을 클릭합니다.
 * 3. 설정 창에서 다음과 같이 선택합니다:
 *    - 실행할 함수: checkWebsiteStatus
 *    - 배포: Head
 *    - 이벤트 소스: 시간 기반
 *    - 트리거 유형: 분 단위 타이머
 *    - 분 간격: 5분마다
 * 4. '저장'을 누릅니다. (권한 승인 팝업이 뜨면 허용해 주세요)
 * ============================================================
 */
```

### 💡 SRE의 조언 (추가 팁)

1.  **권한 승인:** 코드를 처음 실행하거나 트리거를 저장할 때, Google 계정 권한 승인(이메일 발송 및 외부 서비스 연결 권한)이 필요합니다. "안전하지 않은 앱" 경고가 뜨면 `고급` -> `(프로젝트명)으로 이동`을 눌러 승인하세요.
2.  **오탐(False Positive) 방지:** 간혹 네트워크 일시적 지연으로 알림이 올 수 있습니다. 더 정교한 모니터링이 필요하다면, "한 번 실패 시 바로 알림" 대신 "연속 2회 실패 시 알림" 로직으로 수정하는 것을 고려할 수 있습니다.
3.  **로깅:** `console.log`를 넣어두었으므로, Apps Script 대시보드의 '실행' 탭에서 언제 검사가 수행되었고 결과가 어땠는지 로그를 확인할 수 있습니다.