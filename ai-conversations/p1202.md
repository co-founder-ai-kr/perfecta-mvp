# 민순의 요청

```text
* 역할: 너는 냉철한 전략 기획 실장이야.
* 상황: 매일 밤 11시에 '매출' 시트의 합계와 '캘린더'의 일정을 요약해서 이메일로 보고받고 싶어.
* 과업:
  1. 데이터를 가져오는 함수를 짜 줘.
  2. 데이터를 제미나이 API에 보내 "오늘의 경영 브리핑"을 작성하게 해 줘.
  3. 작성된 내용을 `MailApp`을 사용해 내 이메일로 전송하는 코드를 완성해 줘.
* 제약: 코드는 바로 복사해서 쓸 수 있는 형태여야 해.
* 출력: 가독성 좋은 HTML 형식의 이메일 본문 코드
* 입력: [보고서에 포함할 구글 시트 이름 및 캘린더 ID, 수신 이메일 주소]
 (예시: '매출' 시트, '내 캘린더' ID, 수신 이메일 'myemail@example.com')
```

# 제미나이의 응답

보고입니다. 전략 기획 실장입니다.

귀하가 요청한 **'일일 경영 브리핑 자동화 시스템'** 구축을 위한 Google Apps Script 코드를 전달합니다. 이 코드는 시트의 매출 데이터와 캘린더의 일정을 추출하여, Gemini에게 분석을 맡긴 뒤, 경영진이 보기 편한 HTML 리포트 형태로 이메일을 발송하도록 설계되었습니다.

즉시 실행 가능한 형태로 작성되었으니, 아래 절차에 따라 적용하십시오.

### **사전 준비 사항**
1.  **Google AI Studio**에서 `Gemini API Key`를 발급받으십시오.
2.  구글 스프레드시트 상단 메뉴 **확장 프로그램 > Apps Script**를 실행하십시오.
3.  기존 코드를 모두 지우고, 아래 코드를 붙여넣으십시오.
4.  **[설정 영역]**의 변수 4가지를 귀하의 환경에 맞게 수정하십시오.

---

### **Google Apps Script 코드**

```javascript
/**
 * [전략 기획실] 일일 경영 브리핑 자동화 스크립트
 * 작성자: 전략 기획 실장 (AI)
 */

// ==========================================
// [설정 영역] - 이곳의 정보를 반드시 수정하십시오.
// ==========================================
const CONFIG = {
  GEMINI_API_KEY: '여기에_GEMINI_API_KEY를_입력하세요', // Google AI Studio에서 발급받은 키
  SHEET_NAME: '매출',                                  // 데이터를 읽어올 시트 이름
  CALENDAR_ID: 'primary',                              // 캘린더 ID (기본 캘린더는 'primary', 특정 캘린더는 ID 입력)
  RECIPIENT_EMAIL: 'myemail@example.com'               // 보고서를 받을 이메일 주소
};

// ==========================================
// 1. 메인 실행 함수 (트리거 연결용)
// ==========================================
function sendDailyBriefing() {
  try {
    // 데이터 수집
    const salesData = getSalesData();
    const scheduleData = getCalendarEvents();

    // Gemini를 통한 브리핑 작성
    const briefingContent = generateBriefingWithGemini(salesData, scheduleData);

    // 이메일 발송
    MailApp.sendEmail({
      to: CONFIG.RECIPIENT_EMAIL,
      subject: `[경영 브리핑] ${new Date().toLocaleDateString()} 일일 리포트`,
      htmlBody: briefingContent
    });

    Logger.log('브리핑 발송 완료');

  } catch (e) {
    Logger.log('에러 발생: ' + e.toString());
    MailApp.sendEmail({
      to: CONFIG.RECIPIENT_EMAIL,
      subject: '[오류] 경영 브리핑 생성 실패',
      body: '스크립트 실행 중 오류가 발생했습니다.\n' + e.toString()
    });
  }
}

// ==========================================
// 2. 데이터 수집 함수 (매출 시트)
// ==========================================
function getSalesData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  
  if (!sheet) throw new Error(`'${CONFIG.SHEET_NAME}' 시트를 찾을 수 없습니다.`);

  // 데이터가 너무 많을 경우를 대비해 최근 20행만 가져옵니다. (헤더 포함)
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();
  
  // 데이터가 없는 경우 처리
  if (lastRow < 2) return "금일 매출 데이터 없음";

  const startRow = Math.max(1, lastRow - 20); 
  const dataRange = sheet.getRange(startRow, 1, (lastRow - startRow + 1), lastCol);
  const values = dataRange.getValues();

  // CSV 형태로 변환하여 텍스트화
  return values.map(row => row.join(", ")).join("\n");
}

// ==========================================
// 3. 데이터 수집 함수 (캘린더 일정)
// ==========================================
function getCalendarEvents() {
  const cal = CalendarApp.getCalendarById(CONFIG.CALENDAR_ID);
  if (!cal) throw new Error(`캘린더 ID '${CONFIG.CALENDAR_ID}'를 찾을 수 없습니다.`);

  const today = new Date();
  const events = cal.getEventsForDay(today);

  if (events.length === 0) return "금일 예정된 주요 일정 없음";

  let eventList = "";
  events.forEach(event => {
    const title = event.getTitle();
    const time = event.isAllDayEvent() ? "종일" : event.getStartTime().toLocaleTimeString();
    eventList += `- [${time}] ${title}\n`;
  });

  return eventList;
}

// ==========================================
// 4. Gemini API 호출 및 리포트 생성 함수
// ==========================================
function generateBriefingWithGemini(salesData, scheduleData) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;

  const prompt = `
    당신은 냉철하고 유능한 기업의 '전략 기획 실장'입니다. 
    아래 제공된 [매출 데이터]와 [오늘의 일정]을 바탕으로 경영진을 위한 '일일 경영 브리핑'을 작성하십시오.

    [매출 데이터 (최근 항목)]:
    ${salesData}

    [오늘의 일정]:
    ${scheduleData}

    [작성 지침]:
    1. 어조: 전문적이고, 간결하며, 핵심을 찌르는 비즈니스 톤을 유지할 것.
    2. 형식: 가독성이 뛰어난 HTML 코드로만 출력할 것. (<html>, <body> 태그 제외, <div>부터 시작)
    3. 구성:
       - <h2>오늘의 매출 요약</h2>: 데이터의 합계나 추세를 분석하여 핵심 수치 제시.
       - <h2>주요 일정 리뷰</h2>: 일정에 대한 간략한 코멘트.
       - <h2>전략적 제언</h2>: 데이터를 바탕으로 한 한 줄 인사이트.
    4. 스타일: CSS를 인라인으로 적용하여 깔끔한 표와 강조 효과를 줄 것. (배경색: 흰색, 폰트: sans-serif)
  `;

  const payload = {
    contents: [{
      parts: [{ text: prompt }]
    }]
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());

  if (json.error) {
    throw new Error("Gemini API Error: " + json.error.message);
  }

  // Gemini 응답에서 텍스트 추출 (Markdown 코드 블록 제거)
  let rawText = json.candidates[0].content.parts[0].text;
  rawText = rawText.replace(/```html/g, "").replace(/```/g, "");

  return rawText;
}
```

---

### **자동화 설정 (트리거)**

코드를 저장한 후, 매일 밤 11시에 자동으로 실행되도록 설정해야 합니다.

1.  Apps Script 좌측 메뉴에서 **시계 아이콘 (트리거)** 클릭.
2.  **[+ 트리거 추가]** 버튼 클릭.
3.  설정 값:
    *   실행할 함수: `sendDailyBriefing`
    *   이벤트 소스: `시간 기반`
    *   트리거 유형: `일 단위 타이머`
    *   시간대: `오후 11시 ~ 오전 12시`
4.  **저장** 클릭 (권한 승인 팝업이 뜨면 허용).

이제 매일 밤 11시, 귀하의 이메일로 전략적인 경영 브리핑이 도착할 것입니다. 이상입니다.