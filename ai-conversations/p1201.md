# 민순의 요청

```text
* 역할: 너는 Apps Script와 제미나이 API 전문가야.
* 상황: 구글 시트 A열(사용처)과 B열(금액) 데이터를 보고 C열에 지출 성격(식대, 운영비 등)을 자동 입력하고 싶어.
* 과업: 시트 데이터를 한 줄씩 읽어서 제미나이 API에게 보내고, 분류 결과를 받아 C열에 입력하는 스크립트를 짜 줘.
* 제약:
  - API 키는 코드에 직접 쓰지 않고 `PropertiesService`를 통해 불러오도록 작성해 줘.
  - 출력되는 코드는 바로 복사해서 쓸 수 있는 형태여야 해.
* 출력: Apps Script 코드
* 입력: [구글 시트의 데이터 구조 및 분류 기준]
 (예시: A열은 '거래처', B열은 '금액', C열은 '분류'로 하고, '식대', '운영비', '매입 비용' 등으로 분류해 줘.)
```

# 제미나이의 응답

네, Apps Script와 제미나이 API를 활용하여 구글 시트의 지출 내역을 자동으로 분류하는 스크립트를 작성해 드리겠습니다.

요청하신 대로 **API 키 보안(PropertiesService 사용)**과 **복사 붙여넣기 가능한 형태**로 작성했습니다.

### 1. 사전 준비 (API 키 설정)
스크립트를 실행하기 전에, Apps Script 환경에 API 키를 저장해야 합니다. 코드를 붙여넣기 전에 아래 단계를 먼저 수행해 주세요.

1.  구글 시트 상단 메뉴에서 **확장 프로그램 > Apps Script**를 클릭합니다.
2.  왼쪽 사이드바에서 **프로젝트 설정(톱니바퀴 아이콘)**을 클릭합니다.
3.  스크롤을 내려 **스크립트 속성** 섹션에서 **[스크립트 속성 추가]**를 클릭합니다.
4.  **속성**: `GEMINI_API_KEY`
5.  **값**: `발급받은_제미나이_API_키` (sk-로 시작하는 키)
6.  **[스크립트 속성 저장]**을 클릭합니다.

---

### 2. Apps Script 코드
이제 왼쪽 사이드바에서 **편집기(Code.gs)**로 돌아와 아래 코드를 모두 복사해서 붙여넣으세요.

```javascript
/**
 * 구글 시트의 지출 내역을 제미나이 API를 이용해 자동 분류하는 스크립트
 */

function classifyExpenses() {
  // 1. 현재 활성화된 시트와 데이터 가져오기
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const lastRow = sheet.getLastRow();
  
  // 데이터가 없으면 종료 (헤더만 있는 경우 포함)
  if (lastRow < 2) {
    SpreadsheetApp.getUi().alert('데이터가 없습니다.');
    return;
  }

  // A2부터 C열의 마지막 행까지 범위를 가져옵니다. (A: 사용처, B: 금액, C: 분류)
  // 데이터를 한 번에 배열로 가져오는 것이 속도 면에서 유리합니다.
  const range = sheet.getRange(2, 1, lastRow - 1, 3); 
  const values = range.getValues();
  
  // 2. 각 행을 순회하며 분류 작업 수행
  for (let i = 0; i < values.length; i++) {
    const merchant = values[i][0]; // A열: 사용처
    const amount = values[i][1];   // B열: 금액
    const category = values[i][2]; // C열: 분류 (이미 값이 있으면 건너뜀)

    // 사용처가 있고, 분류(C열)가 비어있는 경우에만 API 호출
    if (merchant !== "" && category === "") {
      try {
        // 제미나이에게 물어보기
        const result = callGeminiAPI(merchant, amount);
        
        // 3. 결과를 시트(C열)에 즉시 입력
        // (i + 2)는 실제 시트의 행 번호입니다. (배열은 0부터, 시트는 1부터 시작 + 헤더 1줄)
        sheet.getRange(i + 2, 3).setValue(result);
        
        // API 호출 제한(Rate Limit)을 피하기 위해 약간의 대기 시간 추가 (필요 시 조절)
        Utilities.sleep(500); 
        
      } catch (e) {
        Logger.log('Error at row ' + (i + 2) + ': ' + e.toString());
        sheet.getRange(i + 2, 3).setValue("에러 발생");
      }
    }
  }
  
  SpreadsheetApp.getUi().alert('분류가 완료되었습니다.');
}

/**
 * 제미나이 API를 호출하여 분류 결과를 받아오는 함수
 */
function callGeminiAPI(merchant, amount) {
  // 스크립트 속성에서 API 키를 안전하게 불러옵니다.
  const apiKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  
  if (!apiKey) {
    throw new Error("API 키가 설정되지 않았습니다. 프로젝트 설정 > 스크립트 속성에서 'GEMINI_API_KEY'를 설정해주세요.");
  }

  // 사용할 모델 (gemini-1.5-flash가 빠르고 저렴하여 단순 분류에 적합)
  const model = 'gemini-1.5-flash';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

  // 프롬프트 구성 (원하는 분류 기준을 여기에 명확히 적어주세요)
  const promptText = `
    너는 회계 담당자야. 아래 지출 내역을 보고 가장 적절한 카테고리 하나만 딱 골라서 단답형으로 대답해.
    
    [분류 기준]
    - 식대: 식당, 카페, 편의점(식품), 배달앱 등
    - 운영비: 사무용품, 임대료, 공과금, 소프트웨어 구독, 택시비 등
    - 매입 비용: 원자재 구매, 도매상 거래 등
    - 기타: 위 분류에 속하지 않는 경우
    
    [지출 내역]
    - 사용처: ${merchant}
    - 금액: ${amount}원
    
    [출력 형식]
    설명 없이 카테고리 단어 하나만 출력해 (예: 식대).
  `;

  const payload = {
    "contents": [{
      "parts": [{
        "text": promptText
      }]
    }],
    "generationConfig": {
      "temperature": 0.2, // 낮을수록 일관된 답변을 줍니다.
    }
  };

  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  // API 요청
  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());

  // 응답 처리
  if (json.error) {
    throw new Error(json.error.message);
  }

  // 결과 텍스트 추출 및 공백 제거
  const resultText = json.candidates[0].content.parts[0].text.trim();
  
  // 혹시 모를 줄바꿈 문자 제거
  return resultText.replace(/\n/g, "");
}
```

### 3. 사용 방법

1.  위 코드를 붙여넣고 저장(Ctrl+S)합니다.
2.  상단 툴바의 실행 함수 선택 박스에서 `classifyExpenses`를 선택합니다.
3.  **[실행]** 버튼을 누릅니다.
4.  최초 실행 시 **권한 검토** 팝업이 뜹니다.
    *   `권한 검토` -> 계정 선택 -> `고급` -> `(안전하지 않음)으로 이동` -> `허용`을 순서대로 클릭합니다.
5.  스크립트가 실행되면서 C열에 분류 결과가 한 줄씩 입력됩니다.

### 💡 팁
*   **분류 기준 수정:** 코드 내 `promptText` 변수 안에 있는 `[분류 기준]` 내용을 수정하면 원하시는 대로 분류 로직을 바꿀 수 있습니다.
*   **속도:** 무료 API 계정의 경우 분당 요청 횟수 제한이 있을 수 있어 `Utilities.sleep(500)`(0.5초 대기)를 넣어두었습니다. 데이터가 많다면 이 시간을 조절하거나 배치 처리가 필요할 수 있습니다.