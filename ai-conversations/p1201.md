# 민순의 요청

```text
* 역할: 너는 Apps Script와 제미나이 API 전문가야.
* 상황: 구글 시트의 거래 내역 데이터를 보고 지출 성격을 자동 입력하고 싶어.
* 과업: 시트 데이터를 한 줄씩 읽어서 제미나이 API에게 보내고, 분류 결과를 받아 지정된 열에 입력하는 스크립트를 짜 줘.
* 제약:
  - API 키는 코드에 직접 쓰지 않고 `PropertiesService`를 통해 불러오도록 작성해 줘.
  - 출력되는 코드는 바로 복사해서 쓸 수 있는 형태여야 해.
* 출력: Apps Script 코드
* 입력: [구글 시트의 데이터 구조 및 분류 기준]
 (예시: A열은 '거래처', B열은 '금액', C열은 '분류'로 하고, '식대', '운영비', '매입 비용' 등으로 분류해 줘.)
```

# 제미나이의 응답

네, 구글 시트의 거래 내역을 제미나이(Gemini) API를 이용해 자동으로 분류하는 Apps Script 코드를 작성해 드리겠습니다.

요청하신 대로 **API 키 보안(PropertiesService 사용)**, **행 단위 처리**, **지정된 분류 기준**을 반영했습니다.

### 📋 사전 준비 (필수)
이 코드를 사용하기 전에 Google AI Studio에서 API 키를 발급받아야 합니다.

1.  **Google AI Studio** (https://aistudio.google.com/) 접속 후 API Key 발급.
2.  구글 시트 메뉴에서 **확장 프로그램 > Apps Script** 실행.
3.  아래 코드를 복사해서 붙여넣기.

---

### 💻 Apps Script 코드

```javascript
/**
 * 1. 초기 설정: 제미나이 API 키 저장 함수
 * 이 함수를 한 번만 실행하여 스크립트 속성에 API 키를 저장하세요.
 */
function setGeminiApiKey() {
  // 아래 'YOUR_API_KEY_HERE' 부분에 실제 발급받은 키를 입력하고 실행하세요.
  const apiKey = 'YOUR_API_KEY_HERE'; 
  
  PropertiesService.getScriptProperties().setProperty('GEMINI_API_KEY', apiKey);
  Logger.log('API 키가 안전하게 저장되었습니다.');
}

/**
 * 2. 메인 함수: 지출 내역 자동 분류
 * 시트의 데이터를 읽어 제미나이에게 분류를 요청하고 결과를 입력합니다.
 */
function classifyExpenses() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // 데이터 범위 설정 (헤더 제외, 2행부터 시작)
  // 가정: A열=거래처, B열=금액, C열=분류(결과값)
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    Logger.log('데이터가 없습니다.');
    return;
  }

  // A2부터 C열 마지막 행까지 데이터 가져오기
  const dataRange = sheet.getRange(2, 1, lastRow - 1, 3);
  const data = dataRange.getValues();
  
  // 분류 기준 정의 (프롬프트에 사용)
  const categories = ['식대', '운영비', '매입 비용', '교통비', '소모품비', '기타'];
  
  // 각 행을 순회하며 처리
  for (let i = 0; i < data.length; i++) {
    const transactionName = data[i][0]; // A열: 거래처
    const amount = data[i][1];          // B열: 금액
    const currentCategory = data[i][2]; // C열: 현재 분류 값

    // 거래처명이 없거나, 이미 분류가 되어 있다면 건너뜀 (API 호출 절약)
    if (!transactionName || currentCategory !== '') {
      continue;
    }

    try {
      // 제미나이 API 호출
      const category = callGeminiAPI(transactionName, amount, categories);
      
      // 결과 시트에 입력 (i는 0부터 시작하므로 행 번호는 i + 2)
      sheet.getRange(i + 2, 3).setValue(category);
      Logger.log(`[완료] ${transactionName} -> ${category}`);
      
      // API 속도 제한 방지를 위한 짧은 대기 (필요시 조정)
      Utilities.sleep(500); 
      
    } catch (e) {
      Logger.log(`[에러] ${transactionName} 처리 중 오류: ${e.toString()}`);
      sheet.getRange(i + 2, 3).setValue('에러 발생');
    }
  }
  
  Browser.msgBox('분류 작업이 완료되었습니다.');
}

/**
 * 3. 헬퍼 함수: 제미나이 API 통신
 */
function callGeminiAPI(transaction, amount, categories) {
  const apiKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  
  if (!apiKey) {
    throw new Error('API 키가 설정되지 않았습니다. setGeminiApiKey 함수를 먼저 실행하세요.');
  }

  const model = 'gemini-1.5-flash'; // 빠르고 저렴한 모델 사용
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

  // 프롬프트 구성
  const promptText = `
    역할: 너는 회계 전문가야.
    과업: 아래 거래 내역을 보고 가장 적절한 카테고리를 하나만 골라줘.
    
    [분류 카테고리 목록]
    ${categories.join(', ')}

    [거래 정보]
    - 거래처: ${transaction}
    - 금액: ${amount}원

    제약사항:
    1. 설명이나 마크다운 없이 오직 카테고리 단어 하나만 출력해.
    2. 목록에 없는 경우 가장 가까운 것을 고르거나 '기타'로 분류해.
  `;

  const payload = {
    "contents": [{
      "parts": [{
        "text": promptText
      }]
    }],
    "generationConfig": {
      "temperature": 0.2, // 일관된 답변을 위해 낮게 설정
    }
  };

  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());

  if (json.error) {
    throw new Error(json.error.message);
  }

  // 응답 텍스트 추출 및 공백 제거
  const resultText = json.candidates[0].content.parts[0].text.trim();
  return resultText;
}
```

---

### 🚀 사용 방법

1.  **코드 붙여넣기**: 위 코드를 Apps Script 편집기(`확장 프로그램` > `Apps Script`)에 붙여넣고 저장(💾)합니다.
2.  **API 키 설정**:
    *   `setGeminiApiKey` 함수 안에 `'YOUR_API_KEY_HERE'` 부분을 실제 키로 변경합니다.
    *   상단 툴바에서 `setGeminiApiKey` 함수를 선택하고 **[실행]** 버튼을 누릅니다. (최초 1회만 수행하면 됩니다. 이후 코드에서 키를 지워도 `PropertiesService`에 저장되어 있어 안전합니다.)
    *   *권한 요청 팝업이 뜨면 허용해 주세요.*
3.  **데이터 준비**:
    *   구글 시트의 **A열에 거래처**, **B열에 금액**을 입력합니다. (1행은 헤더)
    *   C열은 비워둡니다.
4.  **분류 실행**:
    *   상단 툴바에서 `classifyExpenses` 함수를 선택하고 **[실행]** 버튼을 누릅니다.
    *   스크립트가 C열이 비어있는 행을 찾아 자동으로 분류를 입력합니다.

### 💡 참고 사항
*   **모델**: 속도와 비용 효율성을 위해 `gemini-1.5-flash` 모델을 사용하도록 설정했습니다.
*   **중복 방지**: 이미 C열에 값이 있는 행은 건너뛰도록 설계되어 있어, 데이터가 추가될 때마다 전체를 다시 처리하지 않고 추가된 부분만 처리할 수 있습니다.
*   **카테고리 수정**: 코드 내 `const categories = [...]` 부분의 목록을 원하시는 대로 수정하여 사용할 수 있습니다.